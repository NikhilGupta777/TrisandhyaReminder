version: 1
frontend:
  # App Root in Amplify Console should be set to 'client'
  phases:
    preBuild:
      commands:
        # --- Node Version Setup ---
        # 1. Install Node 18 (Amplify Gen 2 minimum)
        # This implicitly runs 'nvm install 18' if needed.
        - nvm install 18

        # --- Backend Deployment ---
        # 2. Deploy Amplify backend and generate outputs
        - |
          cd amplify-app
          npm run build
          npx amplify pipeline-deploy --outputs-format json --outputs-path ../amplify_outputs.json
          cd ..

        # --- Dependency Fix (Must run from repository root) ---
        # 3. Install ALL dependencies with the flag to ignore React peer dependency conflicts.
        # This command runs in the repository root and uses the 'package.json' that contains the conflict.
        - npm ci --legacy-peer-deps

        # 4. Change Directory: Navigate into the frontend application directory
        # where the Vite build artifacts and the final code reside.
        - cd client

    build:
      commands:
        # This runs AFTER 'cd client' and executes your combined backend/frontend build script.
        # It handles 'npx amplify pipeline-deploy' (for backend) and 'vite build' (for frontend).
        - npm run build

  artifacts:
    # 'dist' is the output folder relative to the App Root (which is 'client').
    # This correctly points to 'client/dist'.
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      # Cache node_modules installed in the repository root
      - node_modules/**/*
      # Cache client node_modules if any
      - client/node_modules/**/*
# --- Enforce Node Runtime (Optional but Recommended) ---
environmentVariables:
  # Explicitly set the runtime environment to Node 18.
  - variable: NODE_VERSION
    value: "18"